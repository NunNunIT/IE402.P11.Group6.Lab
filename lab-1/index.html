<html>

</html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>IE402.P11.Group6.Lab1 </title>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
  </style>

  <link rel="stylesheet" href="https://js.arcgis.com/4.15/esri/themes/light/main.css" />
  <link rel="stylesheet" href="./index.css" />
  <script src="https://js.arcgis.com/4.15/"></script>

  <script type="module">
    // import data layers
    import places from "./places/index.js";
    import streets from "./streets/index.js";
    import districts from "./districts/index.js";

    // Debounce function for scroll events
    function debounce(func, delay) {
      let debounceTimeout;
      return function (...args) {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    require(["esri/Map", "esri/views/MapView", "esri/Graphic", "esri/layers/GraphicsLayer", "esri/geometry/Polyline"], function (Map, MapView, Graphic, GraphicsLayer, Polyline) {
      // create map
      var map = new Map({
        basemap: "topo-vector",
      });

      // create view
      var view = new MapView({
        container: "viewDiv",
        map: map,
        center: [106.69508635065, 10.851985339727143],
        zoom: 10,
        highlightOptions: {
          color: "rgb(123, 211, 234)",
        },
      });

      // create graphic
      var createGraphic = function (data) {
        return new Graphic({
          geometry: data,
          symbol: data.symbol,
          attributes: data,
          popupTemplate: data.popupTemplate,
        });
      };

      // T·∫°o l·ªõp huy·ªán (graphicsLayer cho huy·ªán)
      var districtLayer = new GraphicsLayer();
      districts.forEach(function (data) {
        districtLayer.add(createGraphic(data));
      });

      // H√†m x·ª≠ ·∫©n/hi·ªán huy·ªán
      var isDistrictVisible = true;
      var toggleAreaButton = document.getElementById('toggleAreaButton');
      toggleAreaButton.addEventListener('click', function () {
        isDistrictVisible = !isDistrictVisible;
        districtLayer.visible = isDistrictVisible;
        toggleAreaButton.textContent = isDistrictVisible ? "·∫®n v√πng" : "üëÅÔ∏è Hi·ªán v√πng";
      });

      // Th√™m l·ªõp huy·ªán v√†o b·∫£n ƒë·ªì
      map.add(districtLayer);

      var streetLayer = new GraphicsLayer();

      // Th√™m l·ªõp v·∫Ω street v√†o b·∫£n ƒë·ªì
      map.add(streetLayer);

      // add streets
      streets.forEach(function (data) {
        streetLayer.add(createGraphic(data));
      });

      map.add(streetLayer);

      // create points layer
      var pointsLayer = new GraphicsLayer();
      pointsLayer.visible = false; // Hidden initially

      places.forEach(function (place) {
        place.forEach(function (data) {
          pointsLayer.add(createGraphic(data));
        });
      });

      map.add(pointsLayer);


      // Toggle points visibility
      var isPointsVisible = false;
      var toggleButton = document.getElementById('toggleButton');

      toggleButton.addEventListener('click', function () {
        isPointsVisible = !isPointsVisible;
        pointsLayer.visible = isPointsVisible;
        toggleButton.textContent = isPointsVisible ? "·∫®n ƒë·ªãa ƒëi·ªÉm" : "üëÅÔ∏è Hi·ªÉn ƒë·ªãa ƒëi·ªÉm";
      });

      // Copy text to clipboard function
      function copyTextToClipboard(text) {
        navigator.clipboard.writeText(text).then(
          function () {
            console.log("Copying to clipboard was successful!");
          },
          function (err) {
            console.error("Could not copy text: ", err);
          }
        );
      }

      // Drawing line functionality
      // Drawing line functionality
      var isDrawing = false;
      var polylinePoints = []; // Store clicked points
      var string_points = ""; // String format for clipboard
      var lineGraphic = null; // Reference to the current line graphic
      var lineLayer = new GraphicsLayer();
      map.add(lineLayer);

      // Toggle drawing mode
      drawLineButton.addEventListener('click', function () {
        isDrawing = !isDrawing;
        drawLineButton.textContent = isDrawing ? "‚úçÔ∏è ƒêang v·∫Ω" : "‚úèÔ∏è V·∫Ω";

        // Khi k·∫øt th√∫c ch·∫ø ƒë·ªô v·∫Ω, kh√¥ng reset polylinePoints v√† string_points.
        // Ch·ªâ c·∫ßn reset khi ng∆∞·ªùi d√πng mu·ªën b·∫Øt ƒë·∫ßu v·∫Ω l·∫°i m·ªôt line m·ªõi (kh√¥ng ph·∫£i khi t·∫Øt ch·∫ø ƒë·ªô v·∫Ω).
        if (!isDrawing) {
          // B·∫°n c√≥ th·ªÉ gi·ªØ nguy√™n c√°c line ƒë√£ v·∫Ω tr√™n b·∫£n ƒë·ªì m√† kh√¥ng x√≥a ƒëi.
          // Kh√¥ng x√≥a lineGraphic ·ªü ƒë√¢y
          console.log("K·∫øt th√∫c ch·∫ø ƒë·ªô v·∫Ω, c√°c line v·∫´n gi·ªØ nguy√™n.");
        }
      });

      // Handle map clicks for drawing
      view.on("click", function (event) {
        if (isDrawing) {
          event.stopPropagation(); // Prevent default zoom on click

          // Get coordinates of clicked point
          const lng = event.mapPoint.longitude.toFixed(8);
          const lat = event.mapPoint.latitude.toFixed(8);
          const point = [lng, lat];

          // Add point to the polyline and string format
          polylinePoints.push([parseFloat(lng), parseFloat(lat)]);
          string_points += `[${lng}, ${lat}],`;

          // Remove the old line if it exists (ch·ªâ x√≥a line n·∫øu b·∫°n mu·ªën v·∫Ω m·ªõi)
          if (lineGraphic) {
            lineLayer.remove(lineGraphic);
          }

          // If there are at least two points, draw the line
          if (polylinePoints.length > 1) {
            var polyline = new Polyline({
              paths: [polylinePoints],
            });

            lineGraphic = new Graphic({
              geometry: polyline,
              symbol: {
                type: "simple-line",
                color: [0, 0, 0], // Black
                width: 1,
              },
            });

            // Add the line to the map
            lineLayer.add(lineGraphic);
          }

          // Copy points to clipboard
          copyTextToClipboard(string_points);
        }
      });

      // Handle Ctrl+Z to undo the last point
      document.addEventListener('keydown', function (event) {
        if (event.ctrlKey && event.key === 'z') {
          if (polylinePoints.length > 0) {
            // Remove the last point from polylinePoints
            polylinePoints.pop();

            // Update the string_points for clipboard
            string_points = polylinePoints.map(pt => `[${pt[0].toFixed(8)}, ${pt[1].toFixed(8)}]`).join(",") + ",";

            // Remove the old line graphic
            if (lineGraphic) {
              lineLayer.remove(lineGraphic);
            }

            // If there are at least two points, draw the updated line
            if (polylinePoints.length > 1) {
              var polyline = new Polyline({
                paths: [polylinePoints],
              });

              lineGraphic = new Graphic({
                geometry: polyline,
                symbol: {
                  type: "simple-line",
                  color: [0, 0, 0], // Black
                  width: 1,
                },
              });

              lineLayer.add(lineGraphic);
            }

            // Update clipboard with new points
            copyTextToClipboard(string_points);
          }
        }
      });

      // Symbol cho ƒëi·ªÉm t√¨m ki·∫øm
      const FINDPLACE_SYMBOL = {
        type: "simple-marker",
        color: [255, 0, 0],  // M√†u ƒë·ªè
        size: 8,
        outline: {
          color: [0, 0, 0],
          width: 1
        }
      };

      // L·ªõp ƒë·ªì h·ªça ƒë·ªÉ hi·ªÉn th·ªã ƒëi·ªÉm
      var findPlaceLayer = new GraphicsLayer();
      map.add(findPlaceLayer);

      // X·ª≠ l√Ω s·ª± ki·ªán Enter ƒë·ªÉ t√¨m t·ªça ƒë·ªô
      document.getElementById('findLocated').addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
          var input = event.target.value;

          // X·ª≠ l√Ω chu·ªói t·ªça ƒë·ªô v√† chuy·ªÉn th√†nh array [lng, lat]
          try {
            var coords = JSON.parse(input);
            if (Array.isArray(coords) && coords.length === 2) {
              var lng = parseFloat(coords[0]);
              var lat = parseFloat(coords[1]);

              if (!isNaN(lng) && !isNaN(lat)) {
                // X√≥a c√°c ƒëi·ªÉm tr∆∞·ªõc ƒë√≥ n·∫øu c√≥
                findPlaceLayer.removeAll();

                // T·∫°o ƒëi·ªÉm m·ªõi v·ªõi t·ªça ƒë·ªô ƒë∆∞·ª£c nh·∫≠p
                var pointGraphic = new Graphic({
                  geometry: {
                    type: "point",
                    longitude: lng,
                    latitude: lat
                  },
                  symbol: FINDPLACE_SYMBOL
                });

                // Th√™m ƒëi·ªÉm v√†o layer v√† hi·ªÉn th·ªã
                findPlaceLayer.add(pointGraphic);

                // Zoom t·ªõi v·ªã tr√≠ ƒëi·ªÉm v·ª´a t√¨m
                view.goTo({
                  center: [lng, lat],
                  zoom: 15  // B·∫°n c√≥ th·ªÉ thay ƒë·ªïi m·ª©c zoom t√πy √Ω
                });
              } else {
                alert("T·ªça ƒë·ªô kh√¥ng h·ª£p l·ªá");
              }
            } else {
              alert("Vui l√≤ng nh·∫≠p t·ªça ƒë·ªô ƒë√∫ng ƒë·ªãnh d·∫°ng [lng, lat]");
            }
          } catch (error) {
            alert("L·ªói khi ph√¢n t√≠ch t·ªça ƒë·ªô. Vui l√≤ng nh·∫≠p t·ªça ƒë·ªô d∆∞·ªõi d·∫°ng [lng, lat]");
          }
        }
      });


      // Copy text to clipboard function
      // function copyTextToClipboard(text) {
      //   navigator.clipboard.writeText(text).then(
      //     function () {
      //       console.log("Copying to clipboard was successful!");
      //     },
      //     function (err) {
      //       console.error("Could not copy text: ", err);
      //     }
      //   );
      // }
    });
  </script>
</head>

<body>
  <div id="viewDiv"></div>
  <div class="button-action">
    <input id="findLocated" name="findLocated" placeholder="T√¨m t·ªça ƒë·ªô" />
    <button id="toggleButton">üëÅÔ∏è Hi·ªán ƒë·ªãa ƒëi·ªÉm</button>
    <button id="toggleAreaButton"> ·∫®n v√πng</button>
    <button id="drawLineButton">‚úèÔ∏è V·∫Ω</button>
  </div>
</body>

</html>